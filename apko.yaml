contents:
  repositories:
    - https://dl-cdn.alpinelinux.org/alpine/v3.19/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.19/community
  packages:
    # Python & runtime
    - python3=3.11.8-r0
    - py3-pip=23.3.1-r0
    - python3-dev=3.11.8-r0
    
    # Node.js & npm
    - nodejs=20.10.0-r0
    - npm=10.2.4-r0
    
    # Network emulation tools (for tc/netem)
    - iproute2=6.6-r1
    - iproute2-doc=6.6-r1
    
    # Build tools
    - gcc=13.2.1_git20231014-r0
    - musl-dev=1.2.4_git20230717-r4
    - build-base=0.5-r3
    
    # System utilities
    - curl=8.5.0-r0
    - wget=1.21.4-r0
    - git=2.42.1-r0
    - bash=5.2.21-r0
    - sudo=1.9.14p3-r0
    - ca-certificates=20231127_1-r0
    
  keyring:
    - https://dl-cdn.alpinelinux.org/alpine/keys/
    - https://dl-cdn.alpinelinux.org/alpine/keys/content

paths:
  - /home/stgen
  - /home/stgen/.ssh
  - /etc/sudoers.d

scripts:
  pre-base: |
    #!/bin/sh
    set -e
    
  base: |
    #!/bin/sh
    set -e
    
    # Create non-root user
    addgroup -S stgen
    adduser -S -G stgen -h /home/stgen -s /bin/bash stgen
    
    # Create necessary directories
    mkdir -p /home/stgen/.ssh
    mkdir -p /home/stgen/app
    mkdir -p /home/stgen/results
    mkdir -p /home/stgen/logs
    
    # Fix permissions
    chown -R stgen:stgen /home/stgen
    chmod 700 /home/stgen/.ssh
    
  post-base: |
    #!/bin/sh
    set -e
    
    # Configure passwordless sudo for network emulation
    echo "stgen ALL=(ALL) NOPASSWD: /sbin/tc, /sbin/ip, /usr/bin/python3" > /etc/sudoers.d/stgen
    chmod 0440 /etc/sudoers.d/stgen
    
    # Clean up package manager cache
    rm -rf /var/cache/apk/*
    
    # Create symlink for common Python tools
    ln -sf /usr/bin/python3 /usr/local/bin/python
    ln -sf /usr/bin/pip3 /usr/local/bin/pip

environment:
  PATH: /home/stgen/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  HOME: /home/stgen
  PYTHONUNBUFFERED: "1"
  NODE_ENV: production

entrypoint:
  type: service
  command: |
    #!/bin/sh
    set -e
    
    # Start backend
    cd /home/stgen/app
    /home/stgen/.local/bin/uvicorn app:app --host 0.0.0.0 --port 8000 &
    BACKEND_PID=$!
    
    # Start frontend
    cd /home/stgen/app/frontend/build
    python3 -m http.server 3000 &
    FRONTEND_PID=$!
    
    # Wait for both
    wait $BACKEND_PID $FRONTEND_PID

cmd: /bin/bash

accounts:
  users:
    - username: stgen
      uid: 1000
      gid: 1000
      home: /home/stgen
      shell: /bin/bash
      groups:
        - stgen

  groups:
    - groupname: stgen
      gid: 1000
